var viewer=null;var defaultServiceUrl="http://www.homermultitext.org/iipsrv?";var defaultServiceZoomService="DeepZoom=";var defaultServicePath="/project/homer/pyramidal/deepzoom/";var defaultServiceSuffix=".tif";var defaultServiceZoomPostfix=".dzi";var defaultLocalpath="image_archive/";var defaultThumbWidth=250;var serviceUrl=defaultServiceUrl;var servicePath=defaultServicePath;var serviceUrlAndPath=serviceUrl+defaultServiceZoomService+servicePath;var imagePath="";var serviceSuffix=defaultServiceSuffix;var servicePostfix=serviceSuffix+defaultServiceZoomPostfix;var localPath=defaultLocalpath;var localSuffix=".dzi";var usePath=localPath;var useSuffix=localSuffix;var useLocal=false;var imgUrn="urn:cite2:hmt:vaimg.2017a:VA012RN_0013@0.208,0.2087,0.086,0.0225";var defaultUrn="urn:cite2:hmt:vaimg.2017a:VA012RN_0013";var roiArray=[];function toggleSidebar(){$("#sidebarToggle").val(($("#sidebarToggle").val()=="Hide")?"Show":"Hide")}function ict2_drawPreview(a){var b=rectToRoi(a);if(useLocal){getLocalPreview(b)}else{getRemotePreview(b)}}function ict2_drawPreviewFromUrn(a){var b=a.split("@")[1].trim();if(useLocal){getLocalPreview(b)}else{getRemotePreview(b)}}function updateShareUrl(){console.log("updating url");var a=window.location.href.split("?")[0];var c="";var b="";console.log(a);if(imgUrn==""){console.log("empty urn")}else{console.log(imgUrn);if(roiArray.length>0){roiArray.forEach(function(d){if(c==""){c+="?"}else{c+="&"}console.log("roi: "+d.roi);c+="urn="+imgUrn+"@"+d.roi})}else{console.log("empty roi");c+="?urn="+imgUrn}}b=a+c;console.log(b);$("a#ict_shareUrl").attr("href",b);$("a#ict_shareUrl").text("Link to Current State")}function getLocalPreview(j){var a=j.split(",")[0];var k=j.split(",")[1];var h=j.split(",")[2];var d=j.split(",")[3];var f=imgUrn.split("@")[0];var b=f.split(":")[4];var c=getImagePathFromUrn(f);var m=localPath+c+b+".jpg";var g=document.createElement("canvas");g.setAttribute("crossOrigin","Anonymous");var l=g.getContext("2d");var e=document.createElement("img");e.setAttribute("crossOrigin","Anonymous");e.setAttribute("src",m);e.onload=function(){g.width=(e.width*h);g.height=(e.height*d);l.drawImage(e,(0-(e.width*a)),(0-(e.height*k)));var n=g.toDataURL("image/png");$("#image_preview").attr("src",n)}}function getRemotePreview(b){var d=imgUrn.split("@")[0];var c=d.split(":")[4];var a=getImagePathFromUrn(d);var e=serviceUrl+"OBJ=IIP,1.0&FIF="+servicePath+a+c+serviceSuffix;e+="&RGN="+b+"&wID="+defaultThumbWidth+"&CVT=JPEG";$("#image_preview").attr("src",e)}jQuery(function(a){var b=get("urn");if(b===undefined){imgUrn=defaultUrn;b=defaultUrn}else{imgUrn=b}updateShareUrl();setUpUI();initOpenSeadragon();a("#sideBarItself").drags()});function initOpenSeadragon(){if(viewer!=null){viewer.destroy();viewer=null}viewer=OpenSeadragon({id:"image_imageContainer",prefixUrl:"css/images/",crossOriginPolicy:"Anonymous",defaultZoomLevel:1,tileSources:getTileSources(imgUrn),minZoomImageRatio:0.1,immediateRender:true});viewer.addHandler("full-screen",function(a){refreshRois()});viewer.guides({allowRotation:false,horizontalGuideButton:null,verticalGuideButton:null,prefixUrl:"css/images/",removeOnClose:false,useSessionStorage:false,navImages:{guideHorizontal:{REST:"guidehorizontal_rest.png",GROUP:"guidehorizontal_grouphover.png",HOVER:"guidehorizontal_hover.png",DOWN:"guidehorizontal_pressed.png"},guideVertical:{REST:"guidevertical_rest.png",GROUP:"guidevertical_grouphover.png",HOVER:"guidevertical_hover.png",DOWN:"guidevertical_pressed.png"}}});selection=viewer.selection({restrictToImage:true,onSelection:function(a){createROI(a)}});setTimeout(function(){loadDefaultROI(imgUrn)},2000)}function loadDefaultROI(a){tempArray=roiArray;roiArray=[];if(a.indexOf("@")>-1){var b=a.split("@")[1];tempArray.push(b)}if(tempArray.length>0){tempArray.forEach(function(d){console.log(d);var f=d;var g=getGroup(roiArray.length+1);var e=a.split("@")[0]+"@"+d;var c={index:roiArray.length,roi:f,mappedUrn:e,group:g.toString()};roiArray.push(c);addRoiOverlay(c);addRoiListing(c)});updateShareUrl()}}function createROI(d){var c=rectToRoi(d);var b=imgUrn+"@"+c;var e=getGroup(roiArray.length+1);var a={index:roiArray.length,roi:c,mappedUrn:b,group:e.toString()};roiArray.push(a);addRoiOverlay(a);addRoiListing(a);updateShareUrl()}function rectToRoi(f){var d=viewer.world.getItemAt(0).getBounds().height;var b=viewer.world.getItemAt(0).getBounds().width;roiRect=viewer.viewport.imageToViewportRectangle(f);var h=roiRect.x/b;var a=roiRect.y/d;var g=roiRect.width/b;var c=roiRect.height/d;var e=h.toPrecision(4)+","+a.toPrecision(4)+","+g.toPrecision(4)+","+c.toPrecision(4);return e}function addRoiListing(b){var g=idForMappedUrn(b.index);var f=idForMappedROI(b.index);var a="image_roiGroup_"+b.group;var e="<a class='deleteLink' title='delete urn' id='delete"+g+"' data-index='"+b.index+"'></a>";var d="<a class='copyLink' title='copy urn' id='copyUrn"+g+"'></a>";var c="<li class='"+a+"' id='"+g+"'>";c+=e+d+b.mappedUrn+"</li>";$("#image_urnList").append(c);$("li#"+g).on("click",function(){if($(this).hasClass("image_roiGroupSelected")){removeAllHighlights()}else{removeAllHighlights();$(this).addClass("image_roiGroupSelected");var h=urnToRoiId(this.id);ict2_drawPreviewFromUrn($("#"+h).data("urn"));$("#"+h).addClass("image_roiGroupSelected")}});$("a#copyUrn"+g).on("click",function(){var j=$("#"+g).text();var l=document.createElement("textarea");l.style.position="fixed";l.style.top=0;l.style.left=0;l.style.width="2em";l.style.height="2em";l.style.padding=0;l.style.border="none";l.style.outline="none";l.style.boxShadow="none";l.style.background="transparent";l.value=j;document.body.appendChild(l);l.select();try{var m=document.execCommand("copy");var k=m?"successful":"unsuccessful";console.log("Copying text command was "+k)}catch(h){console.log("Oops, unable to copy")}document.body.removeChild(l)});$("a#delete"+g).on("click",function(){var j=$(this).prop("id");var h=j.replace("deleteimage_mappedUrn_","");deleteRoi(parseInt(h))})}function deleteRoi(e){var b=[];for(i=0;i<roiArray.length;i++){if(i!=e){b.push(roiArray[i])}}clearJsRoiArray();for(i=0;i<b.length;i++){var d=getGroup(i+1);var a={index:i,roi:b[i].roi,mappedUrn:b[i].mappedUrn,group:d.toString()};roiArray.push(a);addRoiOverlay(roiArray[i]);addRoiListing(roiArray[i])}updateShareUrl()}function refreshRois(){var b=[];for(i=0;i<roiArray.length;i++){b.push(roiArray[i])}clearJsRoiArray();for(i=0;i<b.length;i++){var c=getGroup(i+1);var a={index:i,roi:b[i].roi,mappedUrn:b[i].mappedUrn,group:c.toString()};roiArray.push(a);addRoiOverlay(roiArray[i]);addRoiListing(roiArray[i])}}function get(a){if(a=(new RegExp("[?&]"+encodeURIComponent(a)+"=([^&]*)")).exec(location.search)){var b=window.location.search.substring(1)}if(b!=undefined){var c=b.split("&");c.forEach(function(d){if(d.length>0){if(d.split("=")[1].split("@").length>1){roiArray.push(d.split("=")[1].split("@")[1].split("%")[0])}}})}if(a!=undefined){return decodeURIComponent(a[1])}else{return undefined}}function addRoiOverlay(f){var c=viewer.world.getItemAt(0).getBounds().height;var h=viewer.world.getItemAt(0).getBounds().width;var k=f.roi;var l=+k.split(",")[0];var d=+k.split(",")[1];var b=+k.split(",")[2];var m=+k.split(",")[3];var o=l*h;var j=d*c;var g=b*h;var a=m*c;var n=new OpenSeadragon.Rect(o,j,g,a);var e=document.createElement("a");e.id=idForMappedROI(f.index);e.className="image_mappedROI image_roiGroup_"+f.group+" "+idForMappedUrn(f.index);e.dataset.urn=f.mappedUrn;viewer.addOverlay(e,n);$("a#"+e.id).on("click",function(){if($(this).hasClass("image_roiGroupSelected")){removeAllHighlights()}else{removeAllHighlights();$(this).addClass("image_roiGroupSelected");ict2_drawPreviewFromUrn($(this).data("urn"));var p=roiToUrnId(this.id);$("li#"+p).addClass("image_roiGroupSelected")}})}function removeAllHighlights(){for(i=0;i<roiArray.length;i++){var a=idForMappedUrn(i);var b=idForMappedROI(i);$("li#"+a).removeClass("image_roiGroupSelected");$("a#"+b).removeClass("image_roiGroupSelected")}}function clearJsRoiArray(){for(i=0;i<roiArray.length;i++){var a="image_mappedROI_"+i;viewer.removeOverlay(a)}roiArray=[];$("#image_urnList").empty();$("#image_preview").attr("src","")}function idForMappedUrn(a){var b="image_mappedUrn_"+(a);return b}function idForMappedROI(a){var b="image_mappedROI_"+(a);return b}function roiToUrnId(b){var a=b.replace("image_mappedROI_","image_mappedUrn_");return a}function urnToRoiId(b){var a=b.replace("image_mappedUrn_","image_mappedROI_");return a}function getGroup(b){var c=["#f23568","#6d38ff","#38ffd7","#fff238","#661641","#275fb3","#24a669","#a67b24","#ff38a2","#194973","#35f268","#7f441c","#801c79","#2a8ebf","#216616","#d97330","#da32e6","#196d73","#bdff38","#bf3e2a","#3d1973","#30cdd9","#858c1f","#661616"];var a=c.length;var d=b%a;return d}function reloadImage(){clearJsRoiArray();initOpenSeadragon()}function setUpUI(){$("div#serverConfigs").hide();$("div#localConfigs").show();$("#browse_onoffswitch").prop("checked",true);$("input#image_serverUrlBox").prop("value",serviceUrl);$("input#image_serverUrlPathBox").prop("value",servicePath);$("input#image_localPathBox").prop("value",localPath);$("button#image_changeUrn").on("click",function(){var a=$("input#image_urnBox").prop("value").trim();imgUrn=a;reloadImage()});$("input#image_serverUrlBox").change(function(){serviceUrl=$(this).prop("value");serviceUrlAndPath=serviceUrl+defaultServiceZoomService+servicePath});$("input#image_serverUrlPathBox").change(function(){servicePath=$(this).prop("value");serviceUrlAndPath=serviceUrl+defaultServiceZoomService+servicePath;usePath=serviceUrlAndPath});$("input#image_serverSuffixBox").change(function(){serviceSuffix=$(this).prop("value");servicePostfix=serviceSuffix+defaultServiceZoomPostfix;useSuffix=servicePostfix});$("input#image_localPathBox").change(function(){localPath=$(this).prop("value");usePath=localPath});$("input#image_urnBox").prop("value",imgUrn);if($("#browse_onoffswitch").prop("checked")){useLocal=false;usePath=serviceUrlAndPath;useSuffix=servicePostfix;$("div#serverConfigs").show();$("div#localConfigs").hide()}else{useLocal=true;usePath=localPath;useSuffix=localSuffix;$("div#serverConfigs").hide();$("div#localConfigs").show()}$("#browse_onoffswitch").on("click",function(){if($(this).prop("checked")){useLocal=false;usePath=serviceUrlAndPath;useSuffix=servicePostfix;$("div#serverConfigs").show();$("div#localConfigs").hide();reloadImage()}else{useLocal=true;usePath=localPath;useSuffix=localSuffix;$("div#serverConfigs").hide();$("div#localConfigs").show();reloadImage()}})}function getImagePathFromUrn(b){var c=b.split(":")[2];var d=b.split(":")[3];var f=d.split(".")[0];var a=d.split(".")[1];var e=c+"/"+f+"/"+a+"/";return e}function getTileSources(d){var b=d.split("@")[0];var a=b.split(":")[4];imagePath=getImagePathFromUrn(b);var c="";if(useLocal){c=usePath+imagePath+a+useSuffix}else{c=usePath+imagePath+a+useSuffix}return c};